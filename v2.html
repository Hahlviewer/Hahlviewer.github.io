<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Vorlesungskalender</title>
    <style>
        :root {
            --bg: #ebebeb;
            --fg: #000;
            --lv_fg: #fff;
            --highlighted_fg: #000;
            --overlay_bg: #fff;
            --highlighted_bg: #c3dcff;
            --highlighted_border: #000;
            --border: #afafaf;
        }

        .dark {
            --bg: #131313;
            --fg: #cccccc;
            --lv_fg: #fff;
            --highlighted_fg: #000;
            --overlay_bg: #2c2c2c;
            --highlighted_bg: #30405e;
            --highlighted_border: #fff;
            --border: #666;
        }


        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: var(--bg);
        }

        .controls-wrapper {
            margin: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .controls2 {
            float: right;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .timeline {
            flex: 0.1;
            margin: 5px;
            padding: 10px;
            background: var(--overlay_bg);
            min-height: 140px;
            position: relative;
            border: none;
            border-radius: 8px;
        }

        .time {
            border-top: 1px solid var(--border)
        }

        .calender {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: var(--fg)
        }

        .day {
            flex: 1;
            margin: 5px;
            padding: 10px;
            background: var(--overlay_bg);
            min-height: 140px;
            position: relative;
            border: none;
            border-radius: 8px;
        }

        .today {
            background-color: var(--highlighted_bg);
            font-weight: bold;
        }

        .appointment-container {
            display: grid;
            gap: 4px;
            margin-top: 6px;
            width: 100%;
            grid-template-columns: repeat(1, 1fr);
            grid-template-rows: repeat(37, 10px);
            border-top: 1px solid var(--border)
        }

        .appointment {
            padding: 4px;
            border-radius: 8px;
            font-size: 0.83em;
            /* overflow-wrap: break-word;
            hyphens: auto; */
            color: var(--lv_fg);
            font-weight: normal;
            overflow: hidden;
            white-space: nowrap;

            /* display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1; */
            text-overflow: ellipsis;
        }

        .highlighted {
            border: 2px solid var(--border);
        }

        .caption {
            margin-top: 20px;
            padding-top: 10px;
            color: var(--fg)
        }

        .caption-point {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .caption-color-point {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .highlighted_text {
            color: var(--highlighted_fg);
        }

        .text {
            color: var(--fg);
            margin: 10px;
        }



        footer {
            text-align: center;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        button {
            border: none;
            color: var(--fg);
            background-color: var(--overlay_bg);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        button:hover {
            background-color: var(--highlighted_bg);
        }

        button:active {
            transform: scale(0.95);
        }

        #fileInput {
            display: none;
        }
    </style>
</head>

<body>

    <h1 class="text">Vorlesungskalender</h1>
    <div class="controls-wrapper">
        <div class="controls">
            <button onclick="change_week(-7)">‚Üê</button>
            <button onclick="change_week()">Heute</button>
            <button onclick="change_week(+7)">‚Üí</button>
            <button onclick="document.getElementById('fileInput').click()">üìÅ Dateien ausw√§hlen</button>
            <input type="file" id="fileInput" accept=".txt" multiple>
        </div>
        <div class="controls2">
            <button onclick="toggle_theme()">üåì</button>
        </div>
    </div>


    <div class="calender" id="calender"></div>
    <div class="caption" id="caption"></div>

    <!-- <footer class="text">
        ¬©2025 <a href="https://github.com/programmer-44">E44</a>
    </footer> -->

    <script>
        // Global variables:
        const beginning_time = 8 * 60;
        const letter_count_per_row = 64;
        const browserLanguage = navigator.language || navigator.userLanguage;
        const colors = ["#1976D2", "#388E3C", "#F57C00", "#7B1FA2", "#D32F2F", "#5D4037", "#0097A7"];

        let current_monday = get_monday();

        let appointments = [];
        // {
        //         date: new Date().toDateStr,
        //         time_str: "12:30-14:00",
        //         professor: "Schimske, F.",
        //         info: "Schriftl. Ausarbeitung",
        //         subject: "Technisches Englisch",
        //         location: "Online",
        //         input_file_id: "test24.txt33871293",
        //         id: "test24.txr3274293214234325+423423423423"
        //     }

        let day_infos = {};
        // tag_str: {
        //         column_count: 13
        //     }


        let appointment_positions = {};
        // id: {
        //         start_row: 4,
        //         start_column: 2,
        //         row_lenght: 12,
        //         column_lenght: 2
        //     }

        let input_file_infos = {};
        // input_file_id: {
        //         input_file_name: "test24.txt",
        //         import_date: new Date(),
        //         color: "#232327",
        //         visible: true
        //     }




        // Functions:
        function setThemeClass(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
        }

        function getPreferredTheme() {
            // Check localStorage first
            const stored = localStorage.getItem('theme');
            if (stored) return stored;

            // Fallback to system preference
            return window.matchMedia('(prefers-color-scheme: dark)').matches
                ? 'dark'
                : 'light';
        }

        function toggle_theme() {
            const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            setThemeClass(next);
            localStorage.setItem('theme', next);
        }

        function get_monday(date = new Date()) {
            const day = date.getDay();
            const diff = date.getDate() - (day === 0 ? 6 : day - 1);
            return new Date(date.setDate(diff));
        }

        function get_timeline() {
            const div = document.createElement("div");
            div.className = "timeline";
            div.innerHTML = `<br/><br/>`
            const grid = document.createElement("div");
            grid.className = "appointment-container";
            for (i = 0; i < 10; i++) {
                const time = document.createElement("div");
                time.textContent = `${String(i+8).padStart(2, '0')}:00`;
                time.style.gridRow = `${(i*4)+1} / span 4`;
                if (i != 0) time.className = "time";
                grid.appendChild(time);
            }
            div.appendChild(grid);
            return div;
        }


        function create_empty_calender() {
            const calender_object = document.getElementById("calender");
            calender_object.innerHTML = "";

            calender_object.appendChild(get_timeline())

            for (let i = 0; i < 5; i++) {
                const date = new Date(current_monday);
                date.setDate(date.getDate() + i);
                const weekday = new Intl.DateTimeFormat(browserLanguage, { weekday: 'long' }).format(date);
                const id = date.toDateString();

                const div = document.createElement("div");
                div.className = "day";
                div.id = id;

                if (id === (new Date()).toDateString()) {
                    div.classList.add("today");
                }
                div.innerHTML = `<strong>${weekday}</strong><br/>${date.toLocaleDateString()}<div class="appointment-container" id="container-${id}"></div>`;

                calender_object.appendChild(div);
            }
        }

        function add_appointment_div(appointment) {
            const container = document.getElementById(`container-${appointment.date}`);
            const ap = document.createElement("div");
            ap.className = "appointment";
            if (appointment.info) {
                ap.classList.add("highlighted")
            }
            ap.id = appointment.id;
            ap.style.backgroundColor = input_file_infos[appointment.input_file_id]["color"];
            ap.style.gridColumn = `${appointment_positions[appointment.id]["start_column"]} / span ${appointment_positions[appointment.id]["column_lenght"]}`;
            ap.style.gridRow = `${appointment_positions[appointment.id]["start_row"]+1} / span ${appointment_positions[appointment.id]["row_lenght"]}`;
            // const letter_limit = Math.floor((letter_count_per_row)*(appointment_positions[appointment.id]["column_lenght"]/appointment_positions[appointment.id]["column_count"]));
            let subject = appointment.subject;
            // if (letter_limit < appointment.subject.length) {
            //     subject = subject.slice(0, letter_limit) + "..."
            // }
            ap.innerHTML = `
              <span class="highlighted_text">${appointment.info}</span>
              <strong>${subject}</strong><br>
              ${appointment.time_str}<br>
              ${appointment.professor}<br>
              <em>${appointment.location}</em>
            `;
            container.appendChild(ap);
        }

        function display_appointments() {
            appointments.forEach(appointment => {
                const allowed_days = [];
                for (i = 0; i<5; i++) {
                    const date = new Date(current_monday);
                    date.setDate(current_monday.getDate()+i);
                    allowed_days.push(date.toDateString());
                }
                if (allowed_days.includes(appointment.date)) {
                    if (input_file_infos[appointment.input_file_id].visible) {
                        add_appointment_div(appointment);
                    }
                }
            })
        }

        function change_day_infos() {
            for (let i = 0; i < 5; i++) {
                const date = new Date(current_monday);
                date.setDate(date.getDate() + i);
                const id = date.toDateString()
                if (day_infos[id]) {
                    const day_object = document.getElementById(`container-${id}`);
                    day_object.style.gridTemplateColumns = `repeat(${day_infos[id]["column_count"]}, 1fr)`;
                }
            }
        }



        async function import_files(files) {
            day_infos = {};
            appointment_positions = {};

            const import_date = new Date().toDateString();

            const fileReadPromises = [...files].map((file, index) => {
                return new Promise((resolve, reject) => {
                    // Add to input_file_infos
                    const input_file_id = file.name + index + import_date;
                    const new_input_file_info = {
                        input_file_name: file.name,
                        import_date: import_date,
                        color: colors[Object.keys(input_file_infos).length % colors.length],
                        visible: true
                    };
                    input_file_infos[input_file_id] = new_input_file_info;
                    // Create all appointments
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const decoder = new TextDecoder("windows-1252");
                            const content = decoder.decode(e.target.result);
                            const row = content.split("\n");
                            const data_start_index = row.findIndex(z => z.includes("Raum") && z.includes("Format") && z.includes("Typ")) + 1;
                            if (data_start_index === 0) return resolve();

                            const entry = row.slice(data_start_index + 1).filter(z => z.trim());

                            for (let z = 0; z < entry.length; z += 2) {
                                const row1 = entry[z].trim();
                                const row2 = entry[z + 1]?.trim() || "";

                                const parts1 = row1.split(/\s+/);
                                const date_str = parts1[0];
                                const time_str = parts1[2];

                                let professor;
                                let subject;

                                if (row1.split(parts1[3])[1].split(parts1[4])[0] === " ") {
                                    professor = parts1[3].replace(/_/g, ' ').trim() + ", " + parts1[4].replace(/_/g, ' ').trim();
                                    subject = parts1.slice(5).join(" ");
                                } else {
                                    professor = parts1[3].replace(/_/g, ' ');
                                    subject = parts1.slice(4).join(" ");
                                }
                                professor = professor.replace(/\b\w\b/g, match => match + '.');
                                if (subject.length >= 2 && subject.charAt(subject.length - 2) === " ") {
                                    subject = subject.slice(0, -2);
                                }

                                const [day, month, year] = date_str.split(".");
                                const date = new Date(`20${year}-${month}-${day}`);

                                const parts2 = row2.split(/\s+/);
                                const room = parts2[0];
                                const type = parts2[1];
                                let location = type === "Online-Pr√§senz" ? "Online" : `${type} - ${room}`;
                                let info = parts2.slice(2).join(" ") + "<br/>";
                                if (info === "LV<br/>") info = "";

                                appointments.push({
                                    date: date.toDateString(),
                                    time_str,
                                    professor,
                                    info,
                                    subject,
                                    location,
                                    input_file_id,
                                    id: input_file_id + date.toDateString() + time_str + professor + subject
                                });

                            }
                            resolve();
                        } catch (err) {
                            console.log(err)
                            reject(err); // HIER FEHLER EINF√úGEN
                        }
                    }
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);

                });
            });

            await Promise.all(fileReadPromises);

            create_day_positions();
            update_calender();
            save_into_local_storage();
        }

        function get_simultaneously_appointment_count(ap_a) {
            const range_a = get_start_end_min(ap_a.time_str);
            let array = [];
            appointments.forEach(ap_b => {
                if (ap_a.date === ap_b.date) {
                    const range_b = get_start_end_min(ap_b.time_str);
                    if ((range_a[0] <= range_b[0] && range_a[1] > range_b[0]) || (range_a[0] < range_b[1] && range_a[1] >= range_b[1])) {
                        array.push(ap_b);
                    }
                }
            });
            return array;
        }

        function create_day_positions() {
            let same_time_list = {};
            // {
            //     day_str: [4, 5, 2],
            //     day_str2: [1,2,5]
            // }

            appointments.forEach(appointment => {
                const sim_count = get_simultaneously_appointment_count(appointment).length;
                const day_str = appointment.date;
                if (!same_time_list[day_str]) {
                    same_time_list[day_str] = [sim_count];
                } else if (!same_time_list[day_str].includes(sim_count)) {
                    same_time_list[day_str].push(sim_count);
                }
            });

            for (const day_str in same_time_list) {
                day_infos[day_str] = {
                    column_count: get_grid_columns(same_time_list[day_str])
                }
            }

            appointments.forEach(appointment => {
                const sim_array = get_simultaneously_appointment_count(appointment);
                const day_str = appointment.date;
                const day_columns = day_infos[day_str]["column_count"];

                let sim_placed_counter = -1;
                sim_array.forEach(ap_b => {
                    if (!appointment_positions[ap_b.id]) {
                        sim_placed_counter += 1;
                    }
                })
                const column_width = day_columns / sim_array.length;
                const row_position = get_row_position(appointment.time_str);

                appointment_positions[appointment.id] = {
                    start_row: row_position[0],
                    start_column: (sim_placed_counter * column_width) + 1,
                    row_lenght: row_position[1],
                    column_lenght: column_width,
                    column_count: day_columns
                }
            })
        }

        function get_row_position(time_str) {
            const range = get_start_end_min(time_str);
            const start_row = Math.floor((range[0] - beginning_time) / 15);
            const row_lenght = Math.floor((range[1] - range[0]) / 15);
            return [start_row, row_lenght];
        }


        function timeToMinutes(t) {
            const [h, m] = t.split(":").map(Number);
            return h * 60 + m;
        }

        function get_start_end_min(time_str) {
            const start_min = timeToMinutes(time_str.split("-")[0]);
            const end_min = timeToMinutes(time_str.split("-")[1]);
            return [start_min, end_min];
        }

        function greatest_common_divisor(a, b) {
            while (b !== 0) {
                const temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        function lowest_common_multiple(a, b) {
            return Math.abs(a * b) / greatest_common_divisor(a, b);
        }

        function get_grid_columns(array) {
            const out = array.reduce((acc, val) => lowest_common_multiple(acc, val));
            return out;
        }

        function load_from_local_storage() {
            appointments = JSON.parse(localStorage.getItem("appointments"));
            day_infos = JSON.parse(localStorage.getItem("day_infos"));
            appointment_positions = JSON.parse(localStorage.getItem("appointment_positions"));
            input_file_infos = JSON.parse(localStorage.getItem("input_file_infos"));
            if (appointments === null || day_infos === null || appointment_positions === null || input_file_infos === null) {
                appointments = [];
                day_infos = {};
                appointment_positions = {};
                input_file_infos = {};
                return false;
            } else {
                return true;
            }
        }

        function save_into_local_storage() {
            localStorage.setItem("appointments", JSON.stringify(appointments))
            localStorage.setItem("day_infos", JSON.stringify(day_infos))
            localStorage.setItem("appointment_positions", JSON.stringify(appointment_positions))
            localStorage.setItem("input_file_infos", JSON.stringify(input_file_infos))
        }


        function update_calender() {
            create_empty_calender();
            change_day_infos();
            display_appointments();
        }

        function change_week(value = null) {
            if (value === null) {
                current_monday = get_monday();
            } else {
                current_monday.setDate(current_monday.getDate() + value);
            }
            update_calender();
        }

        document.getElementById("fileInput").addEventListener("change", (e) => {
            change_week();
            import_files(e.target.files);
        });


        // Run while loading the website:
        setThemeClass(getPreferredTheme());
        if (load_from_local_storage()) {
            update_calender();
        } else {
            create_empty_calender();
        }


        // TESTEN:

        // const test_termin = {
        //     date: new Date(),
        //     time_str: "12:30-14:00",
        //     professor: "Schimske, F.",
        //     info: "Schriftl. Ausarbeitung",
        //     subject: "Technisches Englisch",
        //     location: "Online",
        //     input_file_name: 0,
        //     start_row: 4,
        //     start_column: 2,
        //     row_lenght: 12,
        //     column_lenght: 2
        // };
        // const test_div = get_appointment_div(test_termin);
        // const container = document.getElementById(`container-${test_termin.date.toDateString()}`);
        // container.appendChild(test_div);

    </script>
</body>

</html>