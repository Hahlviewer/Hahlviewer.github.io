<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wochenkalender</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }

    h1 {
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .kalender {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .tag {
      flex: 1;
      margin: 5px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      min-height: 140px;
      position: relative;
    }

    .heute {
      background-color: #e0f7fa;
      font-weight: bold;
    }

    .termin-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .termin {
      flex: 1 0 45%;
      padding: 4px;
      border-radius: 4px;
      font-size: 0.85em;
      color: #fff;
      background: #aaa;
    }

    .legende {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }

    .legendenpunkt {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      font-size: 0.95em;
    }

    .farbkreis {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      border: 1px solid #999;
    }

    button {
      padding: 5px 10px;
      font-size: 1em;
    }

    #fileInput {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Wochenkalender</h1>
  <div class="controls">
    <button onclick="vorherigeWoche()">‚Üê</button>
    <button onclick="naechsteWoche()">‚Üí</button>
    <button onclick="document.getElementById('fileInput').click()">üìÅ Dateien ausw√§hlen</button>
    <input type="file" id="fileInput" accept=".txt" multiple>
  </div>

  <div class="kalender" id="kalender"></div>
  <div class="legende" id="legende"></div>

  <script>
    const farben = ["#1976D2", "#388E3C", "#F57C00", "#7B1FA2", "#D32F2F", "#5D4037", "#0097A7"];
    const wochentage = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"];
    let aktuelleWoche = new Date();
    let alleTermine = [];
    let dateiInfos = [];

    function getMontag(datum) {
      const tag = datum.getDay();
      const diff = datum.getDate() - (tag === 0 ? 6 : tag - 1);
      return new Date(datum.setDate(diff));
    }

    function erstelleLeerenKalender() {
      const kalender = document.getElementById("kalender");
      kalender.innerHTML = "";

      const heute = new Date();
      const montag = getMontag(new Date(aktuelleWoche));

      for (let i = 0; i < 5; i++) {
        const datum = new Date(montag);
        datum.setDate(montag.getDate() + i);
        const tagId = datum.toDateString();

        const div = document.createElement("div");
        div.className = "tag";
        div.id = tagId;

        if (heute.toDateString() === datum.toDateString()) {
          div.classList.add("heute");
        }

        div.innerHTML = `<strong>${wochentage[i]}</strong><br>${datum.toLocaleDateString()}<div class="termin-container" id="termine-${tagId}"></div>`;
        kalender.appendChild(div);
      }
    }

    function zeigeTermine() {
      erstelleLeerenKalender();
      const montag = getMontag(new Date(aktuelleWoche));

      alleTermine.forEach(termin => {
        const terminDatum = new Date(termin.datum);
        const diffTage = (terminDatum - montag) / (1000 * 60 * 60 * 24);
        if (diffTage >= 0 && diffTage < 5) {
          const tagId = terminDatum.toDateString();
          const container = document.getElementById(`termine-${tagId}`);
          if (container) {
            const el = document.createElement("div");
            el.className = "termin";
            el.style.backgroundColor = termin.farbe;
            el.innerHTML = `
              <strong>${termin.fach}</strong><br>
              ${termin.uhrzeit}<br>
              ${termin.dozent}<br>
              <em>${termin.raum} ‚Äì ${termin.typ}</em>
            `;
            container.appendChild(el);
          }
        }
      });
    }

    function aktualisiereLegende() {
      const legende = document.getElementById("legende");
      legende.innerHTML = "<h3>Legende</h3>";
      dateiInfos.forEach(info => {
        const el = document.createElement("div");
        el.className = "legendenpunkt";
        el.innerHTML = `<span class="farbkreis" style="background-color: ${info.farbe}"></span>${info.name}`;
        legende.appendChild(el);
      });
    }

    function verarbeiteDateien(dateien) {
      alleTermine = []; // reset
      dateiInfos = [];

      [...dateien].forEach((datei, index) => {
        const reader = new FileReader();
        const farbe = farben[index % farben.length];
        const name = datei.name;

        reader.onload = function(e) {
          const decoder = new TextDecoder("utf-8");
          const inhalt = decoder.decode(e.target.result);
          const zeilen = inhalt.split("\n");
          const datenStartIndex = zeilen.findIndex(z => z.includes("Datum") && z.includes("Fach"));
          if (datenStartIndex === -1) return;

          const eintraege = zeilen.slice(datenStartIndex + 1).filter(z => z.trim());

          for (let z = 0; z < eintraege.length; z += 2) {
            const zeile1 = eintraege[z].trim();
            const zeile2 = eintraege[z + 1]?.trim() || "";

            const parts1 = zeile1.split(/\s+/);
            const datumStr = parts1[0];
            const uhrzeit = parts1[2];
            const dozent = parts1[3];
            const fach = parts1.slice(4).join(" ");

            const [tag, monat, jahr] = datumStr.split(".");
            const datum = new Date(`20${jahr}-${monat}-${tag}`);

            const raum = zeile2.split(/\s{2,}/)[0] || "";
            const typ = zeile2.split(/\s{2,}/)[2] || "";

            alleTermine.push({
              datum,
              uhrzeit,
              dozent,
              fach,
              raum,
              typ,
              farbe
            });
          }

          dateiInfos.push({ name, farbe });
          zeigeTermine();
          aktualisiereLegende();
        };

        reader.readAsArrayBuffer(datei); // => wird dann mit UTF-8 decodiert
      });
    }

    function vorherigeWoche() {
      aktuelleWoche.setDate(aktuelleWoche.getDate() - 7);
      zeigeTermine();
    }

    function naechsteWoche() {
      aktuelleWoche.setDate(aktuelleWoche.getDate() + 7);
      zeigeTermine();
    }

    document.getElementById("fileInput").addEventListener("change", (e) => {
      aktuelleWoche = new Date(); // zur√ºck zur aktuellen Woche beim neuen Upload
      verarbeiteDateien(e.target.files);
    });

    erstelleLeerenKalender();
  </script>

</body>
</html>
