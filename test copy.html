<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Vorlesungskalender</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --fg: #000;
      --lv_fg: #fff;
      --highlighted_fg: #000;
      --overlay_bg: #fff;
      --border: #ccc;
      --highlighted_border: #666;
      --highlighted_bg: #c3dcff;
    }

    .dark {
      --bg: #131313;
      --fg: #cccccc;
      --lv_fg: #fff;
      --highlighted_fg: #000;
      --overlay_bg: #2c2c2c;
      --border: #4d4d4d;
      --highlighted_border: #666;
      --highlighted_bg: #293447;
    }


    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: var(--bg);
    }

    h1 {
      margin-bottom: 10px;
    }

    .controls-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .controls2 {
      float: right;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .kalender {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      color: var(--fg)
    }

    .tag {
      flex: 1;
      margin: 5px;
      padding: 10px;
      background: var(--overlay_bg);
      border: 1px solid var(--border);
      min-height: 140px;
      position: relative;
    }

    .heute {
      background-color: var(--highlighted_bg);
      font-weight: bold;
      border: 1px solid var(--highlighted_border);
    }

    .termin-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .termin {
      flex: 1 0 30%;
      padding: 4px;
      border-radius: 4px;
      font-size: 0.83em;
      overflow-wrap: break-word;
      hyphens: auto;
      color: var(--lv_fg);
      font-weight: normal;
    }

    .legende {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      color: var(--fg)
    }

    .legendenpunkt {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      font-size: 0.95em;
    }

    .farbkreis {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .text {
      color: var(--fg)
    }

    button {
      padding: 5px 10px;
      font-size: 1em;
      background-color: var(--bg);
      color: var(--fg);
      border-color: var(--border);
    }

    #fileInput {
      display: none;
    }
  </style>
</head>
<body>

  <h1 class="text">Vorlesungskalender</h1>
  <div class="controls-wrapper">
    <div class="controls">
      <button onclick="vorherigeWoche()">‚Üê</button>
      <button onclick="heute()">Heute</button>
      <button onclick="naechsteWoche()">‚Üí</button>
      <button onclick="document.getElementById('fileInput').click()">üìÅ Dateien ausw√§hlen</button>
      <input type="file" id="fileInput" accept=".txt" multiple>
    </div>
    <div class="controls2">
      <button onclick="toggle_theme()">üåì</button>
    </div>
  </div>

  <div class="kalender" id="kalender"></div>
  <div class="legende" id="legende"></div>

  <script>
    const farben = ["#1976D2", "#388E3C", "#F57C00", "#7B1FA2", "#D32F2F", "#5D4037", "#0097A7"];
    const wochentage = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"];
    const mintue_to_pixel = 1;
    const start_time = 8 * 60;
    const end_time = 17 * 60;

    let aktuelleWoche = new Date();
    let alleTermine = [];
    let dateiInfos = [];

    function setThemeClass(theme) {
      document.documentElement.classList.toggle('dark', theme === 'dark');
      }

    function getPreferredTheme() {
      // Check localStorage first
      const stored = localStorage.getItem('theme');
      if (stored) return stored;

      // Fallback to system preference
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light';
    }

    setThemeClass(getPreferredTheme());

    function toggle_theme(){
      const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      setThemeClass(next);
      localStorage.setItem('theme', next);
    }

    function getMontag(datum) {
      const tag = datum.getDay();
      const diff = datum.getDate() - (tag === 0 ? 6 : tag - 1);
      return new Date(datum.setDate(diff));
    }

    function erstelleLeerenKalender() {
      const kalender = document.getElementById("kalender");
      kalender.innerHTML = "";

      const heute = new Date();
      const montag = getMontag(new Date(aktuelleWoche));

      for (let i = 0; i < 5; i++) {
        const datum = new Date(montag);
        datum.setDate(montag.getDate() + i);
        const tagId = datum.toDateString();

        const div = document.createElement("div");
        div.className = "tag";
        div.id = tagId;

        if (heute.toDateString() === datum.toDateString()) {
          div.classList.add("heute");
        }

        div.innerHTML = `<strong>${wochentage[i]}</strong><br>${datum.toLocaleDateString()}<div class="termin-container" id="termine-${tagId}"></div>`;
        kalender.appendChild(div);
      }
    }


    function zeigeTermine() {
      erstelleLeerenKalender();
      const montag = getMontag(new Date(aktuelleWoche));

      alleTermine.forEach(termin => {
        const terminDatum = new Date(termin.datum);
        const diffTage = (terminDatum - montag) / (1000 * 60 * 60 * 24);
        if (diffTage >= 0 && diffTage < 5) {
          const tagId = terminDatum.toDateString();
          const container = document.getElementById(`termine-${tagId}`);
          if (container) {
            const el = document.createElement("div");
            el.className = "termin";
            el.style.backgroundColor = termin.farbe;
            el.innerHTML = `
              <strong>${termin.fach}</strong><br>
              ${termin.uhrzeit}<br>
              ${termin.dozent}<br>
              <em>${termin.typ} ‚Äì ${termin.raum}</em>
            `;
            container.appendChild(el);
          }
        }
      });
    }

    function aktualisiereLegende() {
      const legende = document.getElementById("legende");
      legende.innerHTML = "<h3>Legende</h3>";
      dateiInfos.forEach(info => {
        const name_list = info.name.split(".txt")[0].split("_")
        let display_name;
        if (name_list.length > 10) {
          display_name = `${name_list[name_list.length-4]}: ${name_list.slice(1, 3).join(" ")} und ${name_list.slice(4, name_list.length-5).join(" ")} (Stand ${name_list.slice(name_list.length-3).join(" ")})`
        } else if (name_list.length > 7) {
          display_name = `${name_list[name_list.length-4]}: ${name_list.slice(1, name_list.length-5).join(" ")} (Stand ${name_list.slice(name_list.length-3).join(" ")})`
        } else {
          display_name = info.name
        }
        
        const el = document.createElement("div");
        el.className = "legendenpunkt";
        el.innerHTML = `<span class="farbkreis" style="background-color: ${info.farbe}"></span>${display_name}`;
        legende.appendChild(el);
      });
    }

    function desaturate(hex, factor = 0.3) {
      let r = parseInt(hex.slice(1, 3), 16);
      let g = parseInt(hex.slice(3, 5), 16);
      let b = parseInt(hex.slice(5, 7), 16);

      // Richtung Wei√ü mischen (255 = wei√ü)
      r = Math.floor(r + (255 - r) * factor);
      g = Math.floor(g + (255 - g) * factor);
      b = Math.floor(b + (255 - b) * factor);

      return `#${[r, g, b].map(x => x.toString(16).padStart(2, "0")).join("")}`;
}


    function verarbeiteDateien(dateien) {
      alleTermine = []; // reset
      dateiInfos = [];

      [...dateien].forEach((datei, index) => {
        const reader = new FileReader();
        const name = datei.name;
        const farbe = farben[index % farben.length];

        reader.onload = function(e) {
          const decoder = new TextDecoder("windows-1252");
          const inhalt = decoder.decode(e.target.result);
          const zeilen = inhalt.split("\n");
          const datenStartIndex = zeilen.findIndex(z => z.includes("Raum") && z.includes("Format") && z.includes("Typ")) + 1;
          if (datenStartIndex === -1) return;

          const eintraege = zeilen.slice(datenStartIndex + 1).filter(z => z.trim());

          for (let z = 0; z < eintraege.length; z += 2) {
            const zeile1 = eintraege[z].trim();
            const zeile2 = eintraege[z + 1]?.trim() || "";

            const parts1 = zeile1.split(/\s+/);
            const datumStr = parts1[0];
            const uhrzeit = parts1[2];
            
            let dozent;
            let fach;

            if (zeile1.split(parts1[3])[1].split(parts1[4])[0] === " ") {
              dozent = parts1[3].replace(/_/g, ' ').trim() + ", " + parts1[4].replace(/_/g, ' ').trim() + "."
              fach = parts1.slice(5).join(" ");
            } else {
              dozent = parts1[3].replace(/_/g, ' ')
              fach = parts1.slice(4).join(" ");
            }

            const [tag, monat, jahr] = datumStr.split(".");
            const datum = new Date(`20${jahr}-${monat}-${tag}`);

            const parts2 = zeile2.split(/\s+/);
            const raum = parts2[0];
            let typ = parts2[1];
            if (typ === "Online-Pr√§senz") {
              typ = "Online";
            }
            const art = parts2.slice(2).join(" ");

            let aktuelle_farbe = farbe;
            let desaturate_factor = 0;
            if (art !== "LV") {
              fach = art + ":<br/>" + fach;
              desaturate_factor = 0.2;
              aktuelle_farbe = desaturate(farbe);
            }
            //const aktuelle_farbe = desaturate(farbe, desaturate_factor);

            alleTermine.push({
              datum,
              uhrzeit,
              dozent,
              fach,
              raum,
              typ,
              farbe: aktuelle_farbe
            });
          }

          dateiInfos.push({ name, farbe });
          zeigeTermine();
          aktualisiereLegende();
        };

        reader.readAsArrayBuffer(datei); // => wird dann mit UTF-8 decodiert
      });
    }

    function vorherigeWoche() {
      aktuelleWoche.setDate(aktuelleWoche.getDate() - 7);
      zeigeTermine();
    }

    function naechsteWoche() {
      aktuelleWoche.setDate(aktuelleWoche.getDate() + 7);
      zeigeTermine();
    }

    function heute() {
      aktuelleWoche = new Date();
      zeigeTermine();
    }

    document.getElementById("fileInput").addEventListener("change", (e) => {
      aktuelleWoche = new Date(); // zur√ºck zur aktuellen Woche beim neuen Upload
      verarbeiteDateien(e.target.files);
    });

    erstelleLeerenKalender();
  </script>

</body>
</html>
